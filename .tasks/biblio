#!/usr/bin/env bash
#  biblio -*- mode: Bash -*-

set -o nounset

current_script_path="${BASH_SOURCE[0]}"
BIBLIO_SRC=$(realpath "$(dirname "$current_script_path")")

source "$BIBLIO_SRC/lib-util.bash"

#  output --------------------------------------------------

function do_build() {
    header "biblio build [-no-clean] --conf {target:main} --out {out:.temp/site} {src}"
    if help_flag "$@"; then
        echo -e "Build Sphinx from bibtex files
    Uses \$BIBLIO_ROOT
    Args:
    -no-clean         : don't delete existing site files
    --conf {conf dir} : the dir for the conf.py
    --out  {out dir}  : the subdir of .temp/site to build into
    {src dir}         : the dir of source .rst and .bib files

"
        exit 0
    fi
    local do_clean=1
    local conf="$BIBLIO_ROOT"
    local src="$conf/"
    local out="$BIBLIO_ROOT/.temp"
    local site_out="$out/site"
    while [[ $# -gt 0 ]]; do
        case $1 in
            -no-clean|--no-clean)
                do_clean=0
                ;;
            --conf)
                shift
                echo "Conf: $1"
                conf=$(realpath "$1")
                ;;
            --out)
                shift
                echo "Out: $1"
                site_out=$(realpath "$site_out/$1")
                ;;
            *) # Positional
                echo "Src: $1"
                src=$(realpath "$1")
                ;;
        esac
        shift
    done
    echo -e "Building:\n- (conf:$conf)\n- (src:$src)\n->(out:$site_out)"
    if [[ "$do_clean" -gt 0 ]] && [[ -d "${site_out}" ]]; then
        rm -r "${site_out}"
    fi
    uv run sphinx-build \
        --conf-dir "$conf" \
        --doctree-dir "$out/doctrees" \
        --warning-file "$conf/.temp/logs/sphinx.log" \
        --builder "bibhtml" \
        "$src" "$site_out"
}

function do_chunk () {
    header "biblio chunk"
    uv run --script "$BIBLIO_SRC/scripts/bib_chunk.py" "$@"
}

function do_report () {
    header "biblio report"
    uv run --script "$BIBLIO_SRC/scripts/bib_report.py" "$@"
}

function do_android_push () {
    header "TODO: biblio android"
    if help_flag "$@"; then
        echo "help"
        exit 0
    fi
    # setup adb and push biblio_lib
    exit 1
}

function do_tex_compile () {
    header "TODO biblio tex"
    if help_flag "$@"; then
        echo "help"
        exit 0
    fi

    local output="$BIBLIO_ROOT/.temp/tex"
    local template_dir="$BIBLIO_ROOT/templates_"
    # collect tex files, generate separate chapters for each,
    # and export the bibtex files with latex encoding
    uv script --run "$BIBLIO_SRC/scripts/prepare_tex.py" \
        --template-dir "$template_dir" \
        "$@"

    exit 1
    # compile each chapter
    lualatex --interaction=nonstopmode --output-directory="$output" "$output"/*.tex > /dev/null
    BIBINPUT="$output:${BIBINPUTS:-}" bibtex --terse "$output"/*.tex > /dev/null
    lualatex --interaction=nonstopmode --output-directory="$output" "$output"/*.tex /dev/null
    lualatex --interaction=nonstopmode --output-directory="$output" "$output"/*.tex /dev/null

    # join them together
    pdftk cat "$output"/*.pdf output "$output/library.pdf"


}

function do_media_post () {
    header "TODO biblio post"
    uv run --script "$BIBLIO_SRC/scripts/media_post.py" "$@"
    exit 1
}

#  update --------------------------------------------------

function do_bookmarks () {
    header "biblio bookmarks"
    uv run --script "$BIBLIO_SRC/scripts/bookmarks.py" "$@"
}

function do_format () {
    header "biblio format"
    uv run --script "$BIBLIO_SRC/scripts/bib_format.py" "$@"
}

function do_metadata () {
    header "biblio metadata"
    uv run --script "$BIBLIO_SRC/scripts/apply_metadata.py" "$@"
}

function do_online () {
    header "biblio online"
    uv run --script "$BIBLIO_SRC/scripts/bib_online.py" "$@"
}

function do_stub () {
    header "biblio stubs"
    uv run --script "$BIBLIO_SRC/scripts/make_stubs.py" "$@"
}

function do_cleanup () {
    echo "cleanup"
    uv run --script "$BIBLIO_SRC/scripts/clean_todos.py" "$@"
}

function do_tags () {
    header "biblio tags"
    uv run --script "$BIBLIO_SRC/scripts/update_tags.py" "$@"
}

function do_backup () {
    # todo: have a file of backup targets?
    header "biblio --backup"
    if help_flag "$@"; then
        echo "
    Backup arg 1 to arg 2 using rsync
    Uses BIBLIO_LIB
"
        exit 0
    fi

    local source="${1:-$BIBLIO_LIB}"
    local target="${2:-/media/john/solid_ext4/library}"
    header "Biblio Library Backup: $source -> $target"
    rsync --archive --progress "$source" "$target"
}

function do_restructure () {
    header "biblio move"
    uv run --script "$BIBLIO_SRC/scripts/lib_restructure.py" "$@"
}

#   --------------------------------------------------

function print_help () {
    header "biblio scripts"

    echo "
    -h | --help
    backup
    bookmarks
    build
    chunk
    cleanup
    format
    metadata
    move
    online
    post
    report
    stub
"
}

function parse_biblio_args () {
    if [[ "${1:-}" = "biblio" ]]; then
        shift
    fi
    if [[ "$#" -eq 0 ]] || help_flag "$@"; then
        print_help
        exit 0
    fi

    local cmd="$1"
    shift

    case "$cmd" in
        build)
            do_build "$@"
            ;;
        bookmarks)
            do_bookmarks "$@"
            ;;
        post)
            do_media_post "$@"
            ;;
        format)
            do_format "$@"
            ;;
        metadata)
            do_metadata "$@"
            ;;
        online)
            do_online "$@"
            ;;
        stub)
            do_stub "$@"
            ;;
        cleanup)
            do_cleanup "$@"
            ;;
        chunk)
            do_chunk "$@"
            ;;
        backup)
            do_backup "$@"
            ;;
        report)
            do_report "$@"
            ;;
        move)
            do_move "$@"
            ;;
        *) # Positional
            echo "Unknown arg: $cmd"
            exit 1
            ;;
    esac
}

parse_biblio_args "$@"
